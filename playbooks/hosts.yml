---

- hosts: opsmgr_hosts
  become: true
  vars_files:
    - [ ../ext/overrides.yml, defaults/main.yml ]
    - [ ../ext/shared.yml, defaults/shared.yml ]
    - vars/main.yml
  roles:
    - host

- hosts: localhost
  gather_facts: no
  connection: local
  become: false
  vars_files:
    - vars/main.yml
  tasks:
    - name: ensure etc directory exists
      become: false
      file:
          path: "{{ playbook_dir }}/etc"
          state: directory
    - name: clean shared file
      become: false
      file:
          path: "{{ playbook_dir }}/etc/vars.yml"
          state: absent
    - name: insert list of containers to shared file
      become: false
      assemble:
          src: "{{ playbook_dir }}/etc/lxcs/"
          dest: "{{ playbook_dir }}/etc/shared.yml"
    - name: update shared file with a header
      become: false
      lineinfile:
          dest: "{{ playbook_dir }}/etc/shared.yml"
          line: "opsmgr_containers:"
          insertbefore: BOF
    - name: remove temporary directory
      local_action: file path={{ playbook_dir }}/etc/lxcs state=absent
    - name: copy shared file to ext directory
      copy:
          src: "{{ playbook_dir }}/etc/shared.yml"
          dest: "{{ opsmgr_dir }}/ext/shared.yml"


