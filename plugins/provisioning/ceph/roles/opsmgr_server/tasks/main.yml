---

    # ensure opsmgr server can resolve hosts

    - name: update hosts file for nodes that have br-mgmt interface address
      lineinfile: |
          dest=/etc/hosts regexp='.*{{ item }}$'
          line="{{ hostvars[item].ansible_default_ipv4.address }} {{ item }}" state=present
      when: hostvars[item].ansible_default_ipv4.address is defined and item != 'localhost'
      with_items: groups['all']

    # register this target in opsmgr

    - name: clear resources if they already exist
      shell: >
          opsmgr remove_resource -l "{{ item }}"
      with_items: "{{ groups['ceph_monitors'] | union(groups['ceph_osds']) }}"
      ignore_errors: true

    - name: register resource in opsmgr (activate monitoring)
      shell: >
          opsmgr add_resource -l "{{ item }}" -a "{{ hostvars[item].ansible_default_ipv4.address }}"
          -u "{{ ansible_ssh_user }}" --key "/etc/opsmgr/opsmgr.key"
      with_items: "{{ groups['ceph_monitors'] | union(groups['ceph_osds']) }}"

    - name: register ceph_monitors resource role in opsmgr
      shell: >
          opsmgr add_role -l "{{ item }}" -r "ceph_monitors"
      with_items: "{{ groups['ceph_monitors'] }}"

    - name: register ceph_common resource role in opsmgr
      shell: >
          opsmgr add_role -l "{{ item }}" -r "ceph_common"
      with_items: "{{ groups['ceph_monitors'] }}"

    - name: register ceph_osds resource role in opsmgr
      shell: >
          opsmgr add_role -l "{{ item }}" -r "ceph_osds"
      with_items: "{{ groups['ceph_osds'] }}"

    - name: register ceph_common resource role in opsmgr
      shell: >
          opsmgr add_role -l "{{ item }}" -r "ceph_common"
      with_items: "{{ groups['ceph_osds'] }}"


